# Full Code Review (`src/`, `tests/`)

## Scope and method
- Ran static/type/lint/test checks across `src/` and `tests/`:
  - `npm run typecheck`
  - `npm run lint`
  - `npm test`
- Performed targeted manual review on security-sensitive and high-risk areas:
  - Webhook auth/signature/verification middleware
  - Runtime request validation in webhook handlers
  - Config loading and env parsing
  - External API auth client parsing
  - Input sanitization used in dynamic Lark filters

## Findings (ordered by severity)

### 1) High: unvalidated health-check score/body allowed invalid persisted values
- Location: `src/webhook/start.ts:133-167`
- Issue: `score` was cast directly to `1|2|3|4|5` without runtime validation; non-numeric/out-of-range values could be persisted.
- Fix:
  - Added `normalizeScore()` with strict integer range check and safe fallback.
  - Added `lineUserId` runtime type/empty validation with trimming.
  - Added `normalizeMeals()` so only explicit booleans are accepted.
- Result: invalid payloads no longer bypass type assumptions.

### 2) Medium: auth middleware could hang on upstream token verification fetch
- Location: `src/webhook/middleware/auth.ts:22-95`
- Issue: LIFF verification/profile calls had no timeout and weak bearer parsing.
- Fix:
  - Added strict bearer header parser (`/^Bearer\s+(\S+)$/i`).
  - Added max token length guard.
  - Added fetch timeout with `AbortController` for LINE verify/profile calls.
  - Added stronger JSON field validation before accepting token/profile.
- Result: reduced DoS risk from slow upstream calls and malformed auth headers.

### 3) Medium: config port parsing accepted invalid values unsafely
- Location: `src/config/index.ts:39-70,103-105`
- Issue: `parseInt` could allow misconfiguration (e.g. non-integer/invalid ranges) into runtime config.
- Fix:
  - Added `parsePort()` with strict integer + range checks (`1..65535`).
  - Added `ConfigValueError` for invalid configuration values.
- Result: invalid port configuration fails fast and explicitly.

### 4) Medium: Lark token refresh trusted response shape too much
- Location: `src/lark/auth.ts:17-67`
- Issue: response payload fields were assumed present/valid and used via non-null flow.
- Fix:
  - Removed unsafe non-null token return path after refresh.
  - Added payload schema checks for `tenant_access_token` and `expire`.
- Result: stronger runtime safety against malformed external API responses.

### 5) Low: Lark filter sanitization did not neutralize CR/LF
- Location: `src/lark/sanitize.ts:4-8`
- Issue: quote/backslash escaping existed, but newline characters were not normalized.
- Fix:
  - Added CR/LF replacement to spaces.
- Result: safer string literal composition for dynamic filter expressions.

### 6) Low: rich menu health-check URI used non-interpolated placeholder
- Location: `src/line/rich-menu.ts:32-52,68-78`
- Issue: URL used literal `'${LIFF_ID}'` instead of actual value.
- Fix:
  - Updated `createRichMenuObject(liffId: string)`.
  - Updated `setupRichMenu` config to require/pass `liffId`.
- Result: generated URI now correctly targets configured LIFF app.

### 7) Low: lint-breaking unused catch variable in tests
- Location: `tests/e2e/health-check-flow.test.ts:70`
- Issue: unused `_err` violated lint rule.
- Fix: changed to `catch { ... }`.

## Test coverage improvements added
- `tests/webhook/auth.test.ts`
  - Missing header / malformed header / API bearer success / LIFF success / LIFF reject / fetch failure.
- `tests/lark/auth.test.ts`
  - Cached token path / refresh success / non-2xx / invalid payload / non-zero Lark code.
- `tests/lark/sanitize.test.ts`
  - Escape checks + CR/LF normalization check.
- `tests/line/rich-menu.test.ts`
  - Verifies LIFF ID interpolation in URI action.
- `tests/config/index.test.ts`
  - Added invalid `PORT` assertion for `ConfigValueError`.

## Residual risks / gaps
- Lint still reports 51 pre-existing `no-console` warnings in CLI/startup/utility files; no blocking errors remain.
- Coverage thresholds still fail in `test:coverage` due many existing untested modules (not introduced by this patch), notably CLI, `webhook/start.ts`, `webhook/server.ts`, `line/messaging.ts`, and some repositories.

## Validation results after fixes
- `npm run typecheck`: pass
- `npm run lint`: pass (warnings only)
- `npm test`: pass (`28` files, `383` tests)
