# Knowbe2 運用ガイド

B型就労支援事業所向け業務支援システム — 利用シナリオ・業務フロー・CSV作成手順

---

## 1. システム概要

Knowbe2 は、B型就労支援事業所の日常業務を **LINE + Lark** で完結させるツールです。

```
利用者（障害福祉サービス利用者）
  ↓ LINE公式アカウント（スマホで打刻・体調報告）
  ↓
Webhookサーバー（Express）
  ↓
Lark Base（データベース）
  ├── 事業所マスタ / 利用者マスタ / 職員マスタ
  ├── 勤怠記録 / 体調チェック / 支援記録
  ├── 工賃計算 / 請求 / 生産実績
  └── サービスコード / 勤務予定
  ↓
CSV生成エンジン
  ├── 国保連請求CSV（介護給付費等の請求）
  └── 工賃データCSV（利用者別工賃計算）
```

### knowbe（リクルート）との違い

| 項目 | knowbe | Knowbe2 |
|------|--------|---------|
| 利用者UI | 専用Webアプリ | **LINE（全員使い慣れている）** |
| データベース | 自社クラウド | **Lark Base（ダッシュボード付き）** |
| 月額費用 | 数万円/事業所 | **ほぼ無料** |
| カスタマイズ | 不可 | **自由** |

---

## 2. 利用者の1日の流れ

### 朝：出勤打刻

```
① 利用者がLINEを開く
② リッチメニューの「出勤」ボタンをタップ
③ 自動で出勤時刻が記録される
④ LINEに確認メッセージが届く
   「山田太郎さん、おはようございます！ 出勤: 09:30」
```

### 日中：体調チェック

```
① リッチメニューの「体調チェック」ボタンをタップ
② LIFFアプリ（Webフォーム）が開く
③ 入力項目：
   - 体調スコア（1〜5）
   - 睡眠時間
   - 食事（朝・昼・夕）
   - 気分
   - 備考
④ 送信するとLINEに結果が届く
   「😊 体調チェック 4/5 — 山田太郎」
```

### 夕方：退勤打刻

```
① リッチメニューの「退勤」ボタンをタップ
② 自動で退勤時刻が記録される
③ LINEに確認メッセージが届く
   「山田太郎さん、お疲れさまでした！ 退勤: 16:00（実働: 6時間）」
```

### リッチメニュー構成

```
┌─────────────┬─────────────┐
│             │             │
│   🗓 出勤    │  ❤ 体調チェック │
│  (Clock In) │(Health Check)│
│             │             │
├─────────────┼─────────────┤
│             │             │
│  📄 支援記録  │  📱 メニュー  │
│  (Support)  │   (Menu)    │
│             │             │
└─────────────┴─────────────┘
```

---

## 3. 職員の業務フロー

### 日次業務

| 時間帯 | 作業 | 操作方法 |
|--------|------|---------|
| 朝 | 利用者の出勤確認 | Lark Baseで「勤怠記録」テーブルを確認 |
| 日中 | 利用者の体調確認 | Lark Baseで「体調チェック」テーブルを確認 |
| 日中 | 支援記録の作成 | Lark Formから入力 |
| 日中 | 生産実績の記録 | Lark Baseに作業内容・時間を入力 |
| 夕方 | 利用者の退勤確認 | Lark Baseで退勤時刻を確認 |

### 月次業務

| 作業 | 操作方法 | 頻度 |
|------|---------|------|
| 勤怠集計の確認 | Lark Baseのダッシュボードで月次集計を確認 | 月末 |
| 国保連請求CSV作成 | コマンド実行（後述） | 毎月10日まで |
| 工賃計算・CSV作成 | コマンド実行（後述） | 毎月末 |
| 工賃支払い | CSVを元に振込処理 | 翌月初 |

---

## 4. Lark Base のデータ構造

### テーブル一覧（12テーブル）

#### マスタ系

| テーブル | 用途 | 主なフィールド |
|---------|------|---------------|
| **事業所** | 事業所情報 | 事業所番号(10桁)、名称、法人名、地域区分(1-7級地)、報酬体系(Ⅰ-Ⅵ)、定員、保険者番号 |
| **利用者** | 利用者情報 | 受給者証番号(10桁)、氏名、カナ、生年月日、障害支援区分(1-6)、契約支給量、自己負担上限、LINE UserID |
| **職員** | 職員情報 | 氏名、カナ、役職（サービス管理責任者/職業指導員/生活支援員等）、LINE UserID |
| **サービスコード** | 報酬マスタ | サービス種類コード、単位数、加算コード |
| **生産活動** | 作業種別 | 活動名、時間単価（円/時間） |

#### トランザクション系

| テーブル | 用途 | 主なフィールド |
|---------|------|---------------|
| **勤怠記録** | 日々の出退勤 | 日付、出勤時刻、退勤時刻、実績時間(分)、休憩(分)、出欠種別、送迎区分、食事提供 |
| **体調チェック** | 日次の健康状態 | 日付、体調スコア(1-5)、睡眠時間、食事(朝昼夕)、気分、備考 |
| **支援記録** | 職員の支援内容 | 日付、担当職員、支援種別（日常/職業/相談/健康/社会）、内容 |
| **生産実績** | 作業の実績 | 日付、活動、作業時間(分)、数量 |
| **勤務予定** | 月間予定 | 対象年月、予定出勤日数 |

#### 集計・請求系

| テーブル | 用途 | 主なフィールド |
|---------|------|---------------|
| **工賃計算** | 月次の工賃 | 対象年月、出勤日数、作業時間合計、基本工賃、能力給、皆勤手当、控除、支給額、ステータス |
| **請求** | 国保連請求 | 対象年月、請求先、合計単位数、合計金額、利用者負担、ステータス |

---

## 5. 国保連請求CSV作成

### 概要

国民健康保険団体連合会（国保連）に毎月提出する介護給付費等の請求データです。

### 請求計算の仕組み

```
① 出席日数を集計（出欠種別 = "present" の日数）

② 基本報酬単位を計算
   報酬体系Ⅰ: 定員20人以下 → 566単位/日
   報酬体系Ⅱ: 工賃月額に応じた単位数
   報酬体系Ⅲ〜Ⅵ: 定員区分別の単位数

③ 加算を計算
   送迎加算:      21単位 × 送迎対象日数（片道/往復）
   食事提供体制加算: 30単位 × 食事提供日数
   欠席時対応加算:  94単位 × 連絡済み欠席日数（月4回上限）

④ 合計単位数 = 基本報酬 × 出席日数 + 各加算

⑤ 請求額を計算
   請求額 = 合計単位数 × 地域区分単価
   （例: 東京都特別区 = 11.40円/単位）

⑥ 利用者負担を計算
   利用者負担 = min(請求額, 自己負担上限月額)
   給付費    = 請求額 − 利用者負担
```

### 地域区分単価

| 級地 | 地域 | 単価（円） |
|------|------|-----------|
| 1級地 | 東京都特別区 | 11.40 |
| 2級地 | 東京都・横浜市等 | 11.12 |
| 3級地 | さいたま市・千葉市等 | 11.05 |
| 4級地 | 札幌市・仙台市等 | 10.84 |
| 5級地 | 静岡市等 | 10.70 |
| 6級地 | その他都市 | 10.42 |
| 7級地 | その他地域 | 10.21 |
| その他 | 上記以外 | 10.00 |

### CSVファイル仕様

| 項目 | 仕様 |
|------|------|
| 文字コード | **Shift-JIS** |
| 改行コード | **CRLF** |
| レコード構成 | コントロール(1行) + データ(利用者数) + トレーラ(1行) |

#### コントロールレコード（1行目）

```
7121,5,13,,1312345678,20260210,202601
```

| フィールド | 内容 | 例 |
|-----------|------|-----|
| 交換情報識別番号 | 固定値 | 7121 |
| 媒体区分 | 電子媒体 | 5 |
| 都道府県番号 | 事業所番号の先頭2桁 | 13 |
| 保険者番号 | 8桁 | (設定値) |
| 事業所番号 | 10桁 | 1312345678 |
| 作成年月日 | YYYYMMDD | 20260210 |
| 対象年月 | YYYYMM | 202601 |

#### データレコード（利用者ごと）

```
1312345678,612111,0123456789,ヤマダタロウ,19900515,1,612111,011320,20,00011320,0000110700,0000009300,11.4
```

| フィールド | 桁数 | 内容 |
|-----------|------|------|
| 事業所番号 | 10桁 | |
| サービス種類コード | 6桁 | 就労継続支援B型 = 612111 |
| 受給者証番号 | 10桁 | |
| 氏名（カナ） | - | 全角カタカナ |
| 生年月日 | 8桁 | YYYYMMDD |
| 性別 | 1桁 | 1=男, 2=女 |
| サービスコード | 6桁 | |
| 単位数 | 6桁 | ゼロ埋め |
| 日数 | 2桁 | ゼロ埋め |
| サービス単位数合計 | 8桁 | ゼロ埋め |
| 給付費請求額 | 10桁 | ゼロ埋め |
| 利用者負担額 | 10桁 | ゼロ埋め |
| 地域区分単価 | - | 小数点あり |

#### トレーラレコード（最終行）

```
000001,0000011320,000000110700
```

| フィールド | 桁数 | 内容 |
|-----------|------|------|
| 合計件数 | 6桁 | データレコード数 |
| 合計単位数 | 10桁 | |
| 合計請求額 | 12桁 | |

### 操作手順

```bash
# 1. 対象月のデータを確認（Lark Baseで勤怠記録を目視確認）

# 2. 国保連請求CSVを生成
npm run billing:run -- --month=2026-01 --facility=FACILITY_ID

# 3. ドライラン（ファイル出力なし、計算結果のみ確認）
npm run billing:run -- --month=2026-01 --facility=FACILITY_ID --dry-run

# 4. 生成されたCSVを確認
#    → exports/kokuho-ren_202601_FACILITY_ID.csv

# 5. 国保連の電子請求システムにアップロード
```

### バリデーション

CSVを生成する際、以下の自動チェックが行われます：

- 受給者証番号が10桁であること
- 氏名カナが全角カタカナであること
- 生年月日が現実的な日付であること（1900年以降、未来日でない）
- サービス単位数が上限を超えていないこと
- トレーラの合計値がデータレコードの合計と一致すること

---

## 6. 工賃データCSV作成

### 概要

利用者に支払う工賃（賃金）の計算結果をCSVに出力します。

### 工賃計算の仕組み

```
① 出勤日数を集計（出欠種別 = "present"）

② 作業時間を集計（生産実績テーブルの workMinutes 合計）

③ 基本工賃を計算
   基本工賃 = 作業時間(h) × 作業単価(円/h)

④ 手当を加算
   能力給:   スキル評価に基づく（事業所設定）
   皆勤手当: 出勤日数 ≧ 予定日数 の場合に支給

⑤ 合計工賃 = 基本工賃 + 能力給 + 皆勤手当

⑥ 控除を計算
   控除 = 合計工賃 × 控除率

⑦ 支給額 = 合計工賃 − 控除
```

### CSVファイル仕様

| 項目 | 仕様 |
|------|------|
| 文字コード | **UTF-8 BOM** または **Shift-JIS**（選択可） |
| 改行コード | **CRLF** |

#### ヘッダー行

```
利用者番号,氏名,対象年月,出勤日数,作業時間(h),基本工賃,能力給,皆勤手当,合計工賃,控除,支給額
```

#### データ行（例）

```
user-001,山田太郎,2026-01,20,100.00,10000,0,1000,11000,500,10500
user-002,佐藤花子,2026-01,18,85.50,8550,0,0,8550,400,8150
```

### 操作手順

```bash
# 1. 工賃データCSVを生成
npm run billing:run -- --month=2026-01 --facility=FACILITY_ID --type=wage

# 2. エンコーディングを指定（デフォルト: UTF-8 BOM）
npm run csv:export -- --type=wage --month=2026-01 --encoding=shift-jis

# 3. 生成されたCSVを確認
#    → exports/wage_202601_FACILITY_ID.csv
```

### 最低工賃基準

B型就労支援事業所の平均工賃月額は **3,000円以上** が基準です。
平均工賃が3,000円未満の場合、CSVに**警告**が出力されます。

---

## 7. 初期セットアップ手順

### 前提条件

- Node.js 22以上
- LINE公式アカウント（Messaging API設定済み）
- Larkワークスペース（アプリ作成済み）

### 手順

```bash
# 1. リポジトリをクローン
git clone https://github.com/PLark-droid/Knowbe2.git
cd Knowbe2

# 2. 依存パッケージをインストール
npm install

# 3. 環境変数を設定
cp .env.example .env
# .env を編集して以下を設定：
#   LINE_CHANNEL_SECRET, LINE_CHANNEL_ACCESS_TOKEN, LINE_LIFF_ID
#   LARK_APP_ID, LARK_APP_SECRET, LARK_BASE_APP_TOKEN
#   LARK_VERIFICATION_TOKEN

# 4. Lark Baseにテーブルを作成
npx tsx --env-file=.env scripts/provision-lark-base.ts
# → .env に LARK_TABLE_* が自動追記される

# 5. LINEリッチメニューを設定
npx tsx --env-file=.env scripts/setup-line-rich-menu.ts

# 6. Webhookサーバーを起動
npm run webhook:server

# 7. ngrokで外部公開（開発時）
ngrok http 3000

# 8. LINE Developers ConsoleでWebhook URLを設定
#    URL: https://xxxx.ngrok.io/webhook/line

# 9. Lark管理画面でWebhook URLを設定
#    URL: https://xxxx.ngrok.io/webhook/lark
```

### マスタデータの登録

Lark Baseに以下のマスタデータを手動で登録します：

1. **事業所マスタ** — 事業所番号、名称、地域区分、報酬体系、定員
2. **利用者マスタ** — 受給者証番号、氏名、障害支援区分、契約支給量、自己負担上限
3. **職員マスタ** — 氏名、役職
4. **生産活動マスタ** — 作業名、時間単価

---

## 8. トラブルシューティング

### LINEからメッセージが届かない

1. ngrokが起動しているか確認
2. LINE Developers ConsoleのWebhook URLが正しいか確認
3. Webhook検証ボタンで疎通テスト
4. サーバーログで `LINE_CHANNEL_SECRET` エラーがないか確認

### 出勤打刻が記録されない

1. Lark Baseの「利用者」テーブルに `lineUserId` が設定されているか確認
2. サーバーログで `User not found` エラーがないか確認
3. Lark APIのトークンが有効か確認（2時間で期限切れ、自動更新）

### CSVが正しく生成されない

1. 対象月の勤怠データがLark Baseに存在するか確認
2. 事業所マスタの `事業所番号`（10桁）が正しいか確認
3. `--dry-run` で計算結果だけ先に確認
4. Shift-JISエンコーディングで文字化けする場合はExcelの「テキストファイルウィザード」で開く

### 国保連から返戻された

1. 受給者証番号（10桁）が正しいか確認
2. 事業所番号（10桁）が正しいか確認
3. サービス種類コードが事業所の指定に合っているか確認
4. 対象月に有効な受給者証か確認（有効期限）

---

## 9. Lark Base ダッシュボード活用

Lark Baseのビュー機能を使って、以下のダッシュボードを作成できます（開発不要）：

| ダッシュボード | 内容 | 活用場面 |
|--------------|------|---------|
| **月別出勤状況** | 利用者ごとの出勤日数推移グラフ | 月末集計 |
| **体調スコア推移** | 利用者の体調変化を折れ線グラフで可視化 | 支援計画見直し |
| **工賃月次推移** | 利用者別・全体の工賃推移 | 経営管理 |
| **事業所収益** | 国保連請求額の月次推移 | 経営管理 |
| **送迎一覧** | 送迎対象者の日別リスト | 日次の送迎計画 |

---

## 10. 用語集

| 用語 | 説明 |
|------|------|
| B型就労支援 | 障害者が雇用契約なしで働く福祉サービス。工賃が支払われる |
| 国保連 | 国民健康保険団体連合会。請求CSVの提出先 |
| 受給者証番号 | 利用者に発行される10桁の番号 |
| 自己負担上限月額 | 利用者が月に支払う上限額（0円/9,300円/37,200円等） |
| 地域区分 | サービス単価を決める地域の等級（1〜7級地） |
| 報酬体系 | 事業所の報酬計算方式（Ⅰ〜Ⅵ） |
| 加算 | 基本報酬に上乗せされる追加単位（送迎、食事等） |
| 工賃 | 利用者に支払われる賃金（最低基準: 月額3,000円） |
| LIFF | LINE Front-end Framework。LINE内でWebアプリを開く仕組み |
